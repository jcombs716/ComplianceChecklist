import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp, getApps } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged, 
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  collection, 
  onSnapshot, 
  updateDoc, 
  serverTimestamp, 
  writeBatch 
} from 'firebase/firestore';
import { 
  ShieldCheck, 
  ArrowRight, 
  CheckCircle2, 
  AlertTriangle, 
  LayoutDashboard, 
  ShieldAlert, 
  Lock, 
  Database, 
  X, 
  Activity, 
  Building2, 
  Search, 
  Calendar, 
  Globe, 
  PieChart, 
  Sparkles,
  Send,
  MessageSquare,
  Image as ImageIcon,
  Loader2
} from 'lucide-react';

// --- CONFIGURATION ---
const getFirebaseConfig = () => {
  if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config);
  const saved = localStorage.getItem('fb_config_prod');
  return saved ? JSON.parse(saved) : null;
};

const getAppId = () => typeof __app_id !== 'undefined' ? __app_id : 'ny-compliance-pro-v3';
const apiKey = ""; // Handled by environment

export default function App() {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [configError, setConfigError] = useState(false);
  
  // App State
  const [view, setView] = useState('landing'); 
  const [onboardingStep, setOnboardingStep] = useState(1);
  const [districtData, setDistrictData] = useState({ name: '', bedsCode: '' });
  const [buildings, setBuildings] = useState([]);
  const [complianceLogs, setComplianceLogs] = useState({});
  const [activeBuildingId, setActiveBuildingId] = useState(null);
  const [masterTasks, setMasterTasks] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [signingTask, setSigningTask] = useState(null);
  
  // AI State
  const [isAiOpen, setIsAiOpen] = useState(false);
  const [aiQuery, setAiQuery] = useState('');
  const [aiMessages, setAiMessages] = useState([]);
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [generatedImageUrl, setGeneratedImageUrl] = useState(null);

  // --- 1. FIREBASE INITIALIZATION ---
  useEffect(() => {
    const init = async () => {
      try {
        const config = getFirebaseConfig();
        if (!config) { setConfigError(true); setLoading(false); return; }
        const app = getApps().length === 0 ? initializeApp(config) : getApps()[0];
        const _auth = getAuth(app);
        const _db = getFirestore(app);
        setAuth(_auth); setDb(_db);

        const initAuth = async () => {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(_auth, __initial_auth_token);
          } else {
            await signInAnonymously(_auth);
          }
        };
        await initAuth();

        const unsubAuth = onAuthStateChanged(_auth, (u) => {
          setUser(u);
          setLoading(false);
        });
        return () => unsubAuth();
      } catch (err) {
        setConfigError(true);
        setLoading(false);
      }
    };
    init();
  }, []);

  // --- 2. DATA SYNCHRONIZATION ---
  useEffect(() => {
    if (!db || !user) return;
    const appId = getAppId();

    const unsubMaster = onSnapshot(
      collection(db, 'artifacts', appId, 'public', 'data', 'master_tasks'),
      (snap) => setMasterTasks(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
      (err) => console.warn(err)
    );

    const unsubDistrict = onSnapshot(
      doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'district'),
      (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          setDistrictData(data);
          setBuildings(data.buildings || []);
          if (data.buildings?.length > 0 && !activeBuildingId) setActiveBuildingId(data.buildings[0].id);
          setView('dashboard');
        }
      }
    );

    const unsubLogs = onSnapshot(
      collection(db, 'artifacts', appId, 'users', user.uid, 'compliance'),
      (snap) => {
        const logs = {};
        snap.forEach(d => logs[d.id] = d.data());
        setComplianceLogs(logs);
      }
    );

    return () => { unsubMaster(); unsubDistrict(); unsubLogs(); };
  }, [db, user]);

  // --- AI LOGIC ---
  const callAiAuditor = async () => {
    if (!aiQuery.trim()) return;
    const userMsg = { role: 'user', content: aiQuery };
    setAiMessages(prev => [...prev, userMsg]);
    setAiQuery('');
    setIsAiLoading(true);

    try {
      const systemPrompt = `You are the NY Compliance AI Auditor. 
      The current district is ${districtData.name} (BEDS: ${districtData.bedsCode}).
      There are ${buildings.length} buildings.
      Current master mandates: ${masterTasks.map(t => t.name).join(', ')}.
      Compliance data is provided in logs. Answer professionally as a school facilities expert.`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: aiQuery }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] }
        })
      });

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "I couldn't analyze the ledger at this moment.";
      setAiMessages(prev => [...prev, { role: 'assistant', content: text }]);
    } catch (err) {
      setAiMessages(prev => [...prev, { role: 'assistant', content: "Connection to auditing brain failed." }]);
    } finally {
      setIsAiLoading(false);
    }
  };

  const generateReportImage = async () => {
    setIsAiLoading(true);
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          instances: { prompt: `A professional, futuristic holographic data visualization dashboard showing school building compliance metrics for ${districtData.name}, high tech, blue and indigo color scheme, 8k resolution, cinematic lighting.` },
          parameters: { sampleCount: 1 }
        })
      });
      const result = await response.json();
      if (result.predictions?.[0]?.bytesBase64Encoded) {
        setGeneratedImageUrl(`data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`);
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsAiLoading(false);
    }
  };

  // --- ACTIONS ---
  const finalizeSigning = async (notes = "") => {
    if (!db || !user || !activeBuildingId || !signingTask) return;
    const appId = getAppId();
    const logId = `${activeBuildingId}_${signingTask.id}`;
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'compliance', logId), {
      buildingId: activeBuildingId,
      mandateId: signingTask.id,
      status: 'Complete',
      updatedAt: serverTimestamp(),
      notes,
      verificationId: `VER-${Math.random().toString(36).substr(2, 9).toUpperCase()}`
    });
    setSigningTask(null);
  };

  const seedMasterTasks = async () => {
    if (!db || !user) return;
    const appId = getAppId();
    const batch = writeBatch(db);
    const mandates = [
      { id: 'fire_01', name: 'Annual Fire Safety Inspection', frequency: 'Annual', authority: 'NYSED', category: 'Safety', code: 'SED-FS-1', priority: 'Critical' },
      { id: 'lead_01', name: 'Lead-in-Water Testing', frequency: '3-Year', authority: 'NYDOH', category: 'Health', code: 'DOH-LW-3', priority: 'High' },
      { id: 'bcs_01', name: 'Building Condition Survey', frequency: '5-Year', authority: 'NYSED', category: 'Facilities', code: 'SED-BCS-5', priority: 'Medium' }
    ];
    mandates.forEach(m => batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'master_tasks', m.id), m));
    await batch.commit();
  };

  // --- COMPUTED ---
  const currentBuilding = useMemo(() => buildings.find(b => b.id === activeBuildingId), [buildings, activeBuildingId]);
  const buildingStats = useMemo(() => {
    if (!activeBuildingId || masterTasks.length === 0) return { percent: 0, pending: 0 };
    const logs = Object.values(complianceLogs).filter(l => l.buildingId === activeBuildingId && l.status === 'Complete');
    return { percent: Math.round((logs.length / masterTasks.length) * 100), pending: masterTasks.length - logs.length };
  }, [activeBuildingId, complianceLogs, masterTasks]);

  // --- RENDER HELPERS ---
  if (loading) return (
    <div className="h-screen bg-slate-950 flex flex-col items-center justify-center gap-6">
      <div className="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin" />
      <span className="text-indigo-400 font-black tracking-widest uppercase text-xs">Accessing Vault</span>
    </div>
  );

  if (view === 'landing') return (
    <div className="h-screen bg-slate-950 text-white flex flex-col items-center justify-center p-6 text-center">
      <ShieldCheck size={80} className="text-indigo-500 mb-8" />
      <h1 className="text-6xl md:text-8xl font-black italic uppercase tracking-tighter mb-4">Compliance <span className="text-indigo-600">Pro</span></h1>
      <p className="text-slate-400 max-w-xl mb-12">The unified ledger for New York State school mandates.</p>
      <button onClick={() => setView('onboarding')} className="px-12 py-6 bg-indigo-600 rounded-full font-black flex items-center gap-4 hover:scale-105 transition-all">Initialize District <ArrowRight /></button>
    </div>
  );

  if (view === 'onboarding') return (
    <div className="h-screen bg-slate-50 flex items-center justify-center p-6">
      <div className="bg-white p-12 rounded-[3rem] shadow-2xl max-w-lg w-full">
        <h2 className="text-3xl font-black mb-8 italic uppercase tracking-tight">Onboarding Step {onboardingStep}</h2>
        {onboardingStep === 1 ? (
          <div className="space-y-4">
            <input placeholder="District Name" className="w-full p-6 bg-slate-50 rounded-2xl font-bold" value={districtData.name} onChange={e => setDistrictData({...districtData, name: e.target.value})} />
            <input placeholder="BEDS Code" className="w-full p-6 bg-slate-50 rounded-2xl font-bold" value={districtData.bedsCode} onChange={e => setDistrictData({...districtData, bedsCode: e.target.value})} />
            <button onClick={() => setOnboardingStep(2)} className="w-full py-6 bg-slate-900 text-white rounded-2xl font-black">Next</button>
          </div>
        ) : (
          <div className="space-y-4">
            <div className="max-h-40 overflow-auto space-y-2 mb-4">
              {buildings.map(b => <div key={b.id} className="p-4 bg-slate-50 rounded-xl font-bold">{b.name}</div>)}
            </div>
            <input placeholder="Add Building + Enter" className="w-full p-6 border-2 border-dashed rounded-2xl" onKeyDown={e => { if(e.key === 'Enter' && e.target.value) { setBuildings([...buildings, { id: Date.now().toString(), name: e.target.value }]); e.target.value = ''; } }} />
            <button onClick={async () => {
              const appId = getAppId();
              await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'district'), { ...districtData, buildings });
              setView('dashboard');
            }} className="w-full py-6 bg-indigo-600 text-white rounded-2xl font-black">Launch Portfolio</button>
          </div>
        )}
      </div>
    </div>
  );

  return (
    <div className="h-screen bg-[#020617] flex font-sans overflow-hidden">
      {/* Sidebar */}
      <aside className="w-80 border-r border-white/5 flex flex-col p-8">
        <div className="flex items-center gap-3 mb-12">
          <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-black italic">CP</div>
          <span className="text-white font-black tracking-tight truncate uppercase text-sm">{districtData.name}</span>
        </div>
        
        <nav className="flex-1 space-y-2">
          {buildings.map(b => (
            <button 
              key={b.id} 
              onClick={() => setActiveBuildingId(b.id)}
              className={`w-full p-4 rounded-2xl text-left text-xs font-black uppercase tracking-widest transition-all ${activeBuildingId === b.id ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:bg-white/5'}`}
            >
              <Building2 size={14} className="inline mr-3 mb-1" /> {b.name}
            </button>
          ))}
        </nav>

        <button onClick={() => setIsAiOpen(true)} className="mt-auto p-6 bg-indigo-600/10 border border-indigo-500/20 text-indigo-400 rounded-3xl flex items-center gap-3 font-black text-[10px] uppercase tracking-widest hover:bg-indigo-600 hover:text-white transition-all">
          <Sparkles size={16} /> AI Auditor
        </button>
      </aside>

      {/* Main Content */}
      <main className="flex-1 overflow-y-auto bg-slate-50 rounded-l-[3rem] shadow-inner p-12">
        <header className="flex justify-between items-center mb-12">
          <div>
            <h2 className="text-4xl font-black text-slate-900 italic uppercase tracking-tighter">{currentBuilding?.name || 'Select Asset'}</h2>
            <p className="text-slate-400 font-black text-[10px] uppercase tracking-[0.3em] flex items-center gap-2 mt-2"><Database size={12}/> District Node {districtData.bedsCode}</p>
          </div>
          <button onClick={seedMasterTasks} className="px-8 py-4 bg-slate-900 text-white rounded-2xl font-black text-xs uppercase tracking-widest flex items-center gap-3">
            <Activity size={16} /> Sync Mandates
          </button>
        </header>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
          <div className="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
            <p className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-4">Building Readiness</p>
            <h3 className="text-6xl font-black text-slate-900 italic mb-4">{buildingStats.percent}%</h3>
            <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-indigo-600" style={{ width: `${buildingStats.percent}%` }} /></div>
          </div>
          <div className="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
            <p className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-4">Pending Tasks</p>
            <h3 className="text-6xl font-black text-slate-900 italic mb-4">{buildingStats.pending}</h3>
            <span className="text-[9px] font-black bg-orange-100 text-orange-600 px-3 py-1 rounded-full uppercase tracking-widest">Active Action Required</span>
          </div>
          <div className="bg-indigo-600 p-10 rounded-[2.5rem] shadow-xl text-white">
            <p className="text-[10px] font-black uppercase opacity-60 tracking-widest mb-4">Audit Status</p>
            <h3 className="text-6xl font-black italic mb-4">{buildingStats.percent === 100 ? 'Secure' : 'Open'}</h3>
            <ShieldCheck className="opacity-40" />
          </div>
        </div>

        <div className="bg-white rounded-[3rem] p-10 shadow-sm border border-slate-100">
          <div className="flex justify-between items-center mb-10 border-b border-slate-50 pb-6">
            <h4 className="font-black italic uppercase text-xl">Compliance Ledger</h4>
            <div className="relative">
              <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size={16} />
              <input placeholder="Filter tasks..." className="pl-12 pr-6 py-3 bg-slate-50 rounded-xl text-sm" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
            </div>
          </div>
          <div className="space-y-4">
            {masterTasks.filter(t => t.name.toLowerCase().includes(searchTerm.toLowerCase())).map(task => {
              const log = complianceLogs[`${activeBuildingId}_${task.id}`];
              const isDone = log?.status === 'Complete';
              return (
                <div key={task.id} className={`p-8 rounded-[2rem] border-2 transition-all flex items-center justify-between ${isDone ? 'bg-emerald-50 border-emerald-100' : 'bg-white border-slate-50 hover:border-indigo-100'}`}>
                  <div className="flex items-center gap-6">
                    <div className={`w-14 h-14 rounded-2xl flex items-center justify-center ${isDone ? 'bg-emerald-500 text-white' : 'bg-slate-50 text-slate-300'}`}>
                      {isDone ? <CheckCircle2 size={24} /> : <Calendar size={24} />}
                    </div>
                    <div>
                      <h5 className={`font-black uppercase text-sm ${isDone ? 'text-slate-400' : 'text-slate-900'}`}>{task.name}</h5>
                      <p className="text-[10px] font-black text-indigo-400 tracking-widest uppercase mt-1">{task.authority} â€¢ {task.code}</p>
                    </div>
                  </div>
                  {!isDone && <button onClick={() => setSigningTask(task)} className="px-6 py-3 bg-slate-900 text-white rounded-xl font-black text-[10px] uppercase hover:bg-indigo-600 transition-all">Certify</button>}
                </div>
              );
            })}
          </div>
        </div>
      </main>

      {/* Signing Modal */}
      {signingTask && (
        <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-md flex items-center justify-center p-6">
          <div className="bg-white w-full max-w-xl rounded-[3rem] p-12 shadow-2xl">
            <div className="flex justify-between mb-8">
              <h3 className="text-3xl font-black italic uppercase tracking-tighter">Certification</h3>
              <X onClick={() => setSigningTask(null)} className="cursor-pointer" />
            </div>
            <p className="text-slate-500 mb-8 font-medium">You are certifying that <span className="font-black text-indigo-600">{signingTask.name}</span> has been completed for {currentBuilding?.name}.</p>
            <textarea id="signing_notes" className="w-full h-32 bg-slate-50 rounded-2xl p-6 mb-8 text-sm outline-none" placeholder="Notes for audit trail..." />
            <button onClick={() => finalizeSigning(document.getElementById('signing_notes').value)} className="w-full py-6 bg-indigo-600 text-white rounded-2xl font-black uppercase tracking-widest shadow-lg shadow-indigo-600/30">Confirm & Sign</button>
          </div>
        </div>
      )}

      {/* AI Panel */}
      {isAiOpen && (
        <div className="fixed inset-y-0 right-0 w-[500px] bg-white border-l border-slate-100 shadow-2xl flex flex-col animate-in slide-in-from-right duration-300 z-50">
          <div className="p-8 border-b border-slate-50 flex justify-between items-center bg-indigo-600 text-white">
            <div className="flex items-center gap-3">
              <Sparkles size={20} />
              <h3 className="font-black italic uppercase tracking-widest">AI Compliance Auditor</h3>
            </div>
            <X className="cursor-pointer" onClick={() => setIsAiOpen(false)} />
          </div>
          
          <div className="flex-1 overflow-y-auto p-8 space-y-6">
            {aiMessages.map((msg, i) => (
              <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[85%] p-6 rounded-3xl text-sm leading-relaxed font-medium ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-slate-100 text-slate-800 rounded-tl-none'}`}>
                  {msg.content}
                </div>
              </div>
            ))}
            {isAiLoading && <div className="flex justify-start"><div className="bg-slate-100 p-6 rounded-3xl animate-pulse"><Loader2 className="animate-spin" size={16} /></div></div>}
            {generatedImageUrl && (
              <div className="p-4 bg-slate-50 rounded-3xl">
                <p className="text-[10px] font-black uppercase mb-4 text-slate-400">Visual Audit Projection</p>
                <img src={generatedImageUrl} className="w-full rounded-2xl shadow-lg border border-slate-200" alt="Generated Audit Visual" />
              </div>
            )}
          </div>

          <div className="p-8 border-t border-slate-50 bg-slate-50/50">
            <div className="flex gap-4 mb-4">
              <button onClick={generateReportImage} className="flex-1 py-3 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-indigo-50 transition-all">
                <ImageIcon size={14} /> Visual Report
              </button>
            </div>
            <div className="relative">
              <input 
                placeholder="Ask about compliance status..." 
                className="w-full pl-6 pr-16 py-4 bg-white border border-slate-200 rounded-2xl text-sm font-medium"
                value={aiQuery}
                onChange={e => setAiQuery(e.target.value)}
                onKeyDown={e => e.key === 'Enter' && callAiAuditor()}
              />
              <button onClick={callAiAuditor} className="absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 bg-indigo-600 text-white rounded-xl flex items-center justify-center">
                <Send size={16} />
              </button>
            </div>
          </div>
        </div>
      )}

      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,800;1,800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
      `}</style>
    </div>
  );
}
