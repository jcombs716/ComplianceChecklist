import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, 
  signOut 
} from 'firebase/auth';
import { 
  getFirestore, doc, setDoc, getDoc, collection, onSnapshot, 
  updateDoc, query, where, addDoc, deleteDoc 
} from 'firebase/firestore';
import { 
  ShieldCheck, LogOut, Search, CheckCircle2, Circle, Plus, 
  FileText, Calendar, Settings, Trash2, X, Lock, Users, Share2, 
  ChevronRight, Building2, AlertCircle, ExternalLink, ArrowLeft,
  Loader2
} from 'lucide-react';

// --- INITIALIZATION ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'nys-compliance-v1';

const MASTER_TASKS = [
    { id: 'm1', cat: "Facilities", sub: "Structural", task: "Visual Inspection", freq: "Annually", auth: "NYSED" },
    { id: 'm2', cat: "Facilities", sub: "Structural", task: "Building Condition Survey (BCS)", freq: "Every 5 Years", auth: "NYSED" },
    { id: 'm3', cat: "Facilities", sub: "Planning", task: "5-Year Capital Facilities Plan", freq: "Annual Update", auth: "NYSED" },
    { id: 'm4', cat: "Facilities", sub: "Mechanical", task: "Boiler Inspection (High Pressure)", freq: "Annual", auth: "NYS DOL" },
    { id: 'm5', cat: "Facilities", sub: "Mechanical", task: "Boiler Inspection (Low Pressure)", freq: "Every 2 Years", auth: "NYS DOL" },
    { id: 'm6', cat: "Facilities", sub: "Mechanical", task: "Elevator / Chairlift Inspection", freq: "Every 6 Months", auth: "NYS Code Enforcement" },
    { id: 'm7', cat: "Facilities", sub: "Water Systems", task: "Backflow Prevention Test", freq: "Annual", auth: "NYS DOH" },
    { id: 'm8', cat: "Facilities", sub: "Equipment", task: "Gym Bleacher Inspection", freq: "Annual", auth: "NYS Fire Code" },
    { id: 'm9', cat: "Fire Safety", sub: "General", task: "Annual Fire Safety Inspection", freq: "Annually", auth: "NYSED / Fire Code" },
    { id: 'm10', cat: "Fire Safety", sub: "Drills", task: "Fire Evacuation Drills", freq: "12x Year", auth: "NYSED" },
    { id: 'm11', cat: "Fire Safety", sub: "Drills", task: "Lockdown Drills", freq: "4x Year", auth: "NYSED" },
    { id: 'm12', cat: "Fire Safety", sub: "Systems", task: "Fire Alarm System Testing", freq: "Annual", auth: "NYS Fire Code" },
    { id: 'm13', cat: "Environmental", sub: "Water", task: "Lead in Water Testing", freq: "Every 3 Years", auth: "NYS DOH" },
    { id: 'm14', cat: "Environmental", sub: "Asbestos", task: "Asbestos 6-Month Surveillance", freq: "Every 6 Months", auth: "EPA (AHERA)" },
    { id: 'm15', cat: "Health & Safety", sub: "Training", task: "Right-To-Know Training", freq: "Annual", auth: "PESH/OSHA" },
    { id: 'm16', cat: "Admin/Transportation", sub: "Equipment", task: "AED Inspection", freq: "Monthly", auth: "NYSED" }
];

export default function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [view, setView] = useState('landing'); 
  const [error, setError] = useState(null);

  // Database Synced State
  const [districtData, setDistrictData] = useState({ name: '', buildings: [] });
  const [userTasks, setUserTasks] = useState([]);

  // Local Form State
  const [districtNameInput, setDistrictNameInput] = useState('');
  const [buildingsInput, setBuildingsInput] = useState([]);
  const [newBuilding, setNewBuilding] = useState('');

  // 1. Auth Listener (Rule 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) { 
        console.error("Auth init error", e); 
        setError("Authentication failed. Please refresh.");
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // 2. Firestore Real-time Sync (Rule 1 & 2)
  useEffect(() => {
    if (!user) return;
    
    // Path for District Doc: Fixed to have even segments (6 segments)
    // /artifacts/{appId}/public/data/districts/{userId}
    const districtDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'districts', user.uid);
    
    const unsubDistrict = onSnapshot(districtDocRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        const sanitized = {
          name: typeof data.name === 'string' ? data.name : '',
          buildings: Array.isArray(data.buildings) ? data.buildings.map(b => String(b)) : []
        };
        setDistrictData(sanitized);
        // Update input states if user hasn't started typing yet or if view is dashboard
        setDistrictNameInput(prev => prev || sanitized.name);
        setBuildingsInput(prev => (prev.length === 0 ? sanitized.buildings : prev));
        
        if (view === 'landing') setView('dashboard');
      }
    }, (err) => setError(`Sync Error (District): ${err.message}`));

    // Path for Tasks Collection
    const tasksColl = collection(db, 'artifacts', appId, 'public', 'data', 'district_tasks');
    const tasksQuery = query(tasksColl, where('userId', '==', user.uid));
    
    const unsubTasks = onSnapshot(tasksQuery, (snap) => {
      const ts = snap.docs.map(d => {
        const data = d.data();
        return { 
          id: d.id, 
          ...data,
          task: typeof data.task === 'string' ? data.task : String(data.task || ''),
          freq: typeof data.freq === 'string' ? data.freq : String(data.freq || ''),
          auth: typeof data.auth === 'string' ? data.auth : String(data.auth || '')
        };
      });
      setUserTasks(ts);
    }, (err) => setError(`Sync Error (Tasks): ${err.message}`));

    return () => { unsubDistrict(); unsubTasks(); };
  }, [user]);

  const handleSaveDistrict = async () => {
    if (!districtNameInput || !user) return;
    try {
      const districtDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'districts', user.uid);
      await setDoc(districtDocRef, { 
        name: districtNameInput, 
        buildings: buildingsInput,
        ownerId: user.uid,
        updatedAt: new Date().toISOString()
      }, { merge: true });
      setView('selection');
    } catch (e) {
      setError(`Save failed: ${e.message}`);
    }
  };

  const toggleTaskSelection = async (masterTask) => {
    if (!user) return;
    try {
      const existing = userTasks.find(t => t.masterId === masterTask.id);
      if (existing) {
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'district_tasks', existing.id);
        await deleteDoc(docRef);
      } else {
        const tasksColl = collection(db, 'artifacts', appId, 'public', 'data', 'district_tasks');
        await addDoc(tasksColl, {
          ...masterTask,
          masterId: masterTask.id,
          userId: user.uid,
          lastCompleted: null,
          createdAt: new Date().toISOString()
        });
      }
    } catch (e) {
      setError(e.message);
    }
  };

  const updateTaskStatus = async (taskId, date) => {
    if (!user) return;
    try {
      const ref = doc(db, 'artifacts', appId, 'public', 'data', 'district_tasks', taskId);
      await updateDoc(ref, { lastCompleted: date });
    } catch (e) {
      setError(e.message);
    }
  };

  const calculateDueDate = (lastDate, frequency) => {
    if (!lastDate) return "N/A";
    const date = new Date(lastDate);
    const freq = String(frequency || '').toLowerCase();
    if (freq.includes('annual')) date.setFullYear(date.getFullYear() + 1);
    else if (freq.includes('5 years')) date.setFullYear(date.getFullYear() + 5);
    else if (freq.includes('6 months')) date.setMonth(date.getMonth() + 6);
    else if (freq.includes('monthly')) date.setMonth(date.getMonth() + 1);
    else if (freq.includes('weekly')) date.setDate(date.getDate() + 7);
    return date.toLocaleDateString();
  };

  if (loading) return (
    <div className="h-screen flex items-center justify-center bg-white">
      <Loader2 className="animate-spin text-blue-600" size={40} />
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 selection:bg-blue-100">
      <nav className="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('landing')}>
          <ShieldCheck className="text-blue-600 w-8 h-8" />
          <span className="font-bold text-xl tracking-tight uppercase">NYS Compliance <span className="text-blue-600">Matrix</span></span>
        </div>
        <div className="flex items-center gap-4">
          {user && (
            <button onClick={() => signOut(auth)} className="flex items-center gap-2 text-slate-500 hover:text-red-600 px-3 py-1.5 rounded-md transition text-sm font-medium">
              <LogOut size={18} /> Sign Out
            </button>
          )}
        </div>
      </nav>

      <main className="max-w-6xl mx-auto p-6">
        {error && (
          <div className="mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg flex items-start gap-3 shadow-sm">
            <AlertCircle size={20} className="mt-0.5 shrink-0" />
            <div className="flex-1 text-sm">{String(error)}</div>
            <button onClick={() => setError(null)}><X size={18}/></button>
          </div>
        )}

        {view === 'landing' && (
          <div className="py-20 text-center animate-in fade-in slide-in-from-bottom-4 duration-700">
            <div className="inline-block px-4 py-1.5 bg-blue-50 text-blue-700 rounded-full text-xs font-bold uppercase tracking-wider mb-6">Built for NYS Public Schools</div>
            <h1 className="text-5xl md:text-6xl font-extrabold mb-6 tracking-tight">Audit-Ready Compliance <br/><span className="text-blue-600">Unified.</span></h1>
            <p className="text-xl text-slate-600 max-w-2xl mx-auto mb-10 leading-relaxed">Centralize your NYSED, DOH, and Fire Code mandates in a single collaborative dashboard.</p>
            <div className="flex justify-center gap-4">
              <button onClick={() => setView('district')} className="bg-blue-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-blue-700 shadow-xl shadow-blue-200 transition-all hover:-translate-y-1">Get Started</button>
            </div>
          </div>
        )}

        {view === 'district' && (
          <div className="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-xl border border-slate-200">
            <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><Building2 className="text-blue-600"/> District Setup</h2>
            <div className="space-y-5">
              <div>
                <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">School District Name</label>
                <input 
                  type="text" 
                  value={districtNameInput} 
                  onChange={(e) => setDistrictNameInput(e.target.value)} 
                  className="w-full p-4 bg-slate-50 border-0 rounded-xl outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 transition" 
                  placeholder="e.g. Buffalo City School District" 
                />
              </div>
              <div>
                <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Buildings</label>
                <div className="flex gap-2 mb-4">
                  <input 
                    type="text" 
                    value={newBuilding} 
                    onChange={(e) => setNewBuilding(e.target.value)} 
                    className="flex-1 p-4 bg-slate-50 border-0 rounded-xl outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500" 
                    placeholder="e.g. Middle School" 
                    onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), document.getElementById('add-bldg-btn').click())}
                  />
                  <button 
                    id="add-bldg-btn"
                    onClick={() => { 
                      if (newBuilding.trim()) {
                        setBuildingsInput(prev => [...prev, newBuilding.trim()]);
                        setNewBuilding(''); 
                      }
                    }} 
                    className="bg-slate-800 text-white px-5 rounded-xl hover:bg-slate-700 transition"
                  >
                    <Plus size={20}/>
                  </button>
                </div>
                <div className="space-y-2">
                  {buildingsInput.map((b, idx) => (
                    <div key={idx} className="flex items-center justify-between p-3 bg-white rounded-lg border border-slate-100 shadow-sm">
                      <span className="font-semibold text-slate-700">{String(b)}</span>
                      <button onClick={() => setBuildingsInput(prev => prev.filter((_, i) => i !== idx))} className="text-slate-300 hover:text-red-500 transition"><Trash2 size={16}/></button>
                    </div>
                  ))}
                </div>
              </div>
              <button 
                onClick={handleSaveDistrict} 
                disabled={!districtNameInput || buildingsInput.length === 0} 
                className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition disabled:opacity-50 mt-4"
              >
                Save & Continue
              </button>
            </div>
          </div>
        )}

        {view === 'selection' && (
          <div className="animate-in fade-in duration-500">
            <div className="flex items-center justify-between mb-8">
              <div>
                <button onClick={() => setView('district')} className="text-sm font-bold text-blue-600 flex items-center gap-1 mb-2">← Edit District Info</button>
                <h2 className="text-3xl font-bold tracking-tight">Select Relevant Mandates</h2>
              </div>
              <button onClick={() => setView('dashboard')} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition">Go to Dashboard</button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {MASTER_TASKS.map(task => {
                const isSelected = userTasks.some(t => t.masterId === task.id);
                return (
                  <div 
                    key={task.id} 
                    onClick={() => toggleTaskSelection(task)}
                    className={`p-5 rounded-2xl border-2 transition-all cursor-pointer relative overflow-hidden group ${isSelected ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-white bg-white hover:border-slate-200 shadow-sm'}`}
                  >
                    <div className="flex justify-between items-start mb-3">
                      <span className={`text-[10px] font-black uppercase tracking-widest px-2 py-0.5 rounded-md ${isSelected ? 'bg-blue-200 text-blue-800' : 'bg-slate-100 text-slate-500'}`}>
                        {String(task.cat)}
                      </span>
                      {isSelected ? <CheckCircle2 className="text-blue-600 shrink-0" size={20}/> : <Circle className="text-slate-200 shrink-0" size={20}/>}
                    </div>
                    <h4 className="font-bold text-slate-800 mb-1 leading-snug">{String(task.task)}</h4>
                    <p className="text-xs text-slate-400 font-medium">{String(task.auth)} • {String(task.freq)}</p>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {view === 'dashboard' && (
          <div className="animate-in fade-in duration-500">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-10">
              <div>
                <h1 className="text-3xl font-black text-slate-900 leading-none mb-2">{String(districtData.name || "District")} Compliance</h1>
                <div className="flex items-center gap-2 text-slate-400 text-sm font-medium">
                   <Building2 size={14}/> {districtData.buildings.length} Registered Buildings
                </div>
              </div>
              <button onClick={() => setView('selection')} className="bg-white border-2 border-slate-100 px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 hover:bg-slate-50 transition shadow-sm">
                <Plus size={18} className="text-blue-600"/> Modify Tracked Items
              </button>
            </div>

            <div className="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden">
              <div className="p-6 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                <h3 className="font-bold text-lg">Mandate Compliance Status</h3>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-left">
                  <thead>
                    <tr className="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-100">
                      <th className="px-6 py-4">Required Item</th>
                      <th className="px-6 py-4">Last Event</th>
                      <th className="px-6 py-4">Next Required</th>
                      <th className="px-6 py-4 text-center">Status</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {userTasks.map(task => {
                      return (
                        <tr key={task.id} className="hover:bg-slate-50/50 transition">
                          <td className="px-6 py-5">
                            <span className="font-bold text-slate-800 block">{String(task.task)}</span>
                            <span className="text-[10px] font-bold text-blue-500 uppercase tracking-tighter">{String(task.auth)}</span>
                          </td>
                          <td className="px-6 py-5">
                            <input 
                              type="date" 
                              value={task.lastCompleted || ''} 
                              onChange={(e) => updateTaskStatus(task.id, e.target.value)}
                              className="bg-slate-100/50 border-0 p-2 rounded-lg text-xs font-bold focus:ring-2 focus:ring-blue-500 outline-none" 
                            />
                          </td>
                          <td className="px-6 py-5">
                            <span className="font-mono text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded">
                              {calculateDueDate(task.lastCompleted, task.freq)}
                            </span>
                          </td>
                          <td className="px-6 py-5">
                            <div className="flex justify-center">
                              {task.lastCompleted ? (
                                <span className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-[10px] font-black uppercase flex items-center gap-1.5">
                                  <CheckCircle2 size={12}/> Compliant
                                </span>
                              ) : (
                                <span className="bg-red-100 text-red-700 px-3 py-1 rounded-full text-[10px] font-black uppercase flex items-center gap-1.5 animate-pulse">
                                  <AlertCircle size={12}/> Pending
                                </span>
                              )}
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                    {userTasks.length === 0 && (
                      <tr>
                        <td colSpan="4" className="py-20 text-center text-slate-400 italic font-medium">No tasks selected. Click "Modify Tracked Items" to begin.</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}
      </main>
    </div>
  );
}
