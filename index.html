<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NY District Compliance Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .animate-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        function App() {
            const [onboarded, setOnboarded] = useState(false);
            const [onboardingStep, setOnboardingStep] = useState(1);
            
            // User & District Data
            const [userData, setUserData] = useState({
                districtName: '',
                userName: '',
                userTitle: ''
            });

            const [activeView, setActiveView] = useState('checklist');
            const [expandedTaskId, setExpandedTaskId] = useState(null);
            const [selectedBuilding, setSelectedBuilding] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [notification, setNotification] = useState(null);

            // District Configuration
            const [buildings, setBuildings] = useState([]);

            // Master Compliance Data
            const masterList = [
                { category: "Facilities", subcategory: "Structural", name: "Visual Inspection", frequency: "Annually", authority: "NYSED", action: "Inspection", performedBy: "Team (incl. Code Official)", citation: "8 NYCRR § 155.4" },
                { category: "Facilities", subcategory: "Structural", name: "Building Condition Survey (BCS)", frequency: "Every 5 Years", authority: "NYSED", action: "Survey & Report", performedBy: "Licensed Architect/PE", citation: "8 NYCRR § 155.4" },
                { category: "Facilities", subcategory: "Planning", name: "5-Year Capital Facilities Plan", frequency: "Annual Update", authority: "NYSED", action: "Review & Update", performedBy: "BOE / Facilities Admin", citation: "8 NYCRR § 155.1" },
                { category: "Facilities", subcategory: "Mechanical", name: "Boiler Inspection (High Pressure)", frequency: "Annual", authority: "NYS Dept of Labor", action: "Inspection", performedBy: "Authorized Inspector", citation: "Labor Law § 204" },
                { category: "Facilities", subcategory: "Mechanical", name: "Boiler Inspection (Low Pressure)", frequency: "Every 2 Years", authority: "NYS Dept of Labor", action: "Inspection", performedBy: "Authorized Inspector", citation: "Labor Law § 204" },
                { category: "Facilities", subcategory: "Mechanical", name: "Elevator / Chairlift Inspection", frequency: "Every 6 Months", authority: "NYS Code Enforcement", action: "Inspection", performedBy: "Licensed Inspector", citation: "PMCNYS § 606.1" },
                { category: "Facilities", subcategory: "Water Systems", name: "Backflow Prevention Test", frequency: "Annual", authority: "NYS DOH", action: "Testing", performedBy: "Certified Tester", citation: "10 NYCRR § 5-1.31" },
                { category: "Facilities", subcategory: "Equipment", name: "Gym Bleacher Inspection", frequency: "Annual", authority: "NYS Fire Code", action: "Inspection", performedBy: "Qualified Person", citation: "FCNYS § 1029.1.1" },
                { category: "Fire Safety", subcategory: "General", name: "Annual Fire Safety Inspection", frequency: "Annually", authority: "NYSED / Fire Code", action: "Inspection", performedBy: "Code Enforcement Official", citation: "Ed. Law § 807-A" },
                { category: "Fire Safety", subcategory: "Drills", name: "Fire Evacuation Drills", frequency: "12x Year", authority: "NYSED", action: "Drill Execution", performedBy: "Principal / In-House", citation: "Ed. Law § 807" },
                { category: "Fire Safety", subcategory: "Drills", name: "Lockdown Drills", frequency: "4x Year", authority: "NYSED", action: "Drill Execution", performedBy: "Principal / In-House", citation: "Ed. Law § 807" },
                { category: "Fire Safety", subcategory: "Systems", name: "Fire Alarm System Testing", frequency: "Annual", authority: "NYS Fire Code", action: "Testing", performedBy: "Licensed Contractor", citation: "FCNYS § 907.8" },
                { category: "Environmental", subcategory: "Water", name: "Lead in Water Testing", frequency: "Every 3 Years", authority: "NYS DOH", action: "Sampling & Lab Test", performedBy: "In-House / Lab", citation: "10 NYCRR § 67-4" },
                { category: "Environmental", subcategory: "Asbestos", name: "Asbestos 6-Month Surveillance", frequency: "Every 6 Months", authority: "EPA (AHERA)", action: "Visual Inspection", performedBy: "In-House / LEA Designee", citation: "40 CFR § 763.92" },
                { category: "Health & Safety", subcategory: "Medical", name: "AED Inspection", frequency: "Monthly", authority: "NYSED", action: "Check Readiness", performedBy: "Nurse / Vendor", citation: "Ed. Law § 917" }
            ];

            const [tasks, setTasks] = useState([]);

            const initializeTasksForBuildings = (buildingList) => {
                const initial = [];
                buildingList.forEach(b => {
                    masterList.forEach((m, idx) => {
                        initial.push({
                            ...m,
                            id: `${b}-${idx}-${Date.now()}`,
                            building: b,
                            attachments: [],
                            completed: false,
                            applicable: true,
                            notes: ""
                        });
                    });
                });
                setTasks(initial);
            };

            const handleOnboardingComplete = () => {
                if (buildings.length === 0) {
                    alert("Please add at least one building to your district.");
                    return;
                }
                initializeTasksForBuildings(buildings);
                setSelectedBuilding(buildings[0]);
                setOnboarded(true);
            };

            const showNotification = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            const toggleTask = (id) => {
                setTasks(tasks.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
            };

            const toggleApplicable = (id) => {
                setTasks(tasks.map(t => t.id === id ? { ...t, applicable: !t.applicable } : t));
            };

            const handleFileUpload = (taskId) => {
                const fileName = prompt("Enter simulated filename (e.g., certificate.pdf):");
                if (!fileName) return;
                setTasks(tasks.map(t => t.id === taskId ? {
                    ...t,
                    attachments: [...t.attachments, { name: fileName, date: new Date().toLocaleDateString() }]
                } : t));
                showNotification("Document attached successfully!");
            };

            const filteredTasks = tasks.filter(t => 
                t.building === selectedBuilding && 
                t.applicable &&
                (t.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                 t.category.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            const groupedTasks = filteredTasks.reduce((acc, task) => {
                if (!acc[task.category]) acc[task.category] = [];
                acc[task.category].push(task);
                return acc;
            }, {});

            if (!onboarded) {
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6">
                        <div className="max-w-md w-full bg-white rounded-3xl shadow-2xl overflow-hidden animate-in">
                            <div className="bg-indigo-600 p-8 text-white">
                                <div className="flex items-center gap-3 mb-2">
                                    <Icon name="shield-check" size={32} />
                                    <h1 className="text-2xl font-black">NY Compliance</h1>
                                </div>
                                <p className="text-indigo-100 text-sm">Setup your district workspace</p>
                            </div>

                            <div className="p-8">
                                {onboardingStep === 1 ? (
                                    <div className="space-y-6">
                                        <h2 className="text-xl font-bold text-slate-800">Your Information</h2>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-[10px] font-black text-slate-400 uppercase block mb-1">Full Name</label>
                                                <input 
                                                    type="text" 
                                                    className="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"
                                                    placeholder="John Doe"
                                                    value={userData.userName}
                                                    onChange={e => setUserData({...userData, userName: e.target.value})}
                                                />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-black text-slate-400 uppercase block mb-1">Title / Role</label>
                                                <input 
                                                    type="text" 
                                                    className="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"
                                                    placeholder="Director of Facilities"
                                                    value={userData.userTitle}
                                                    onChange={e => setUserData({...userData, userTitle: e.target.value})}
                                                />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-black text-slate-400 uppercase block mb-1">School District Name</label>
                                                <input 
                                                    type="text" 
                                                    className="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"
                                                    placeholder="Central School District"
                                                    value={userData.districtName}
                                                    onChange={e => setUserData({...userData, districtName: e.target.value})}
                                                />
                                            </div>
                                        </div>
                                        <button 
                                            disabled={!userData.districtName || !userData.userName}
                                            onClick={() => setOnboardingStep(2)}
                                            className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 disabled:opacity-50 transition-all"
                                        >
                                            Next: Add Buildings
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-6">
                                        <div className="flex items-center justify-between">
                                            <h2 className="text-xl font-bold text-slate-800">Add Buildings</h2>
                                            <button onClick={() => setOnboardingStep(1)} className="text-xs text-slate-400 hover:text-indigo-600 font-bold">Go Back</button>
                                        </div>
                                        <p className="text-sm text-slate-500">List all facilities in the {userData.districtName}. Each will receive the master compliance checklist.</p>
                                        
                                        <div className="space-y-2 max-h-48 overflow-y-auto">
                                            {buildings.map((b, idx) => (
                                                <div key={idx} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
                                                    <span className="text-sm font-bold text-slate-700">{b}</span>
                                                    <button onClick={() => setBuildings(buildings.filter((_, i) => i !== idx))}><Icon name="trash-2" size={14} className="text-slate-300 hover:text-red-500" /></button>
                                                </div>
                                            ))}
                                        </div>

                                        <div className="flex gap-2">
                                            <input 
                                                id="new-building-input"
                                                type="text" 
                                                className="flex-1 p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                                                placeholder="e.g. High School"
                                                onKeyDown={e => {
                                                    if (e.key === 'Enter' && e.target.value) {
                                                        setBuildings([...buildings, e.target.value]);
                                                        e.target.value = '';
                                                    }
                                                }}
                                            />
                                            <button 
                                                onClick={() => {
                                                    const input = document.getElementById('new-building-input');
                                                    if (input.value) {
                                                        setBuildings([...buildings, input.value]);
                                                        input.value = '';
                                                    }
                                                }}
                                                className="p-3 bg-indigo-100 text-indigo-600 rounded-xl hover:bg-indigo-200"
                                            >
                                                <Icon name="plus" />
                                            </button>
                                        </div>

                                        <button 
                                            onClick={handleOnboardingComplete}
                                            className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 transition-all flex items-center justify-center gap-2"
                                        >
                                            Complete Setup <Icon name="arrow-right" size={18} />
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen bg-slate-50">
                    {/* Sidebar */}
                    <aside className="w-64 bg-slate-900 text-slate-300 flex flex-col shrink-0">
                        <div className="p-6 border-b border-slate-800">
                            <div className="flex items-center gap-3 mb-1">
                                <Icon name="shield-check" size={24} className="text-indigo-400" />
                                <h1 className="font-bold text-white text-md truncate">{userData.districtName}</h1>
                            </div>
                            <div className="flex items-center gap-2 text-[10px] text-slate-500 font-bold uppercase tracking-wider">
                                <Icon name="user" size={10} /> {userData.userName}
                            </div>
                        </div>
                        
                        <div className="p-4 flex-1 overflow-y-auto">
                            <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 ml-2">Buildings</p>
                            {buildings.map(b => (
                                <button 
                                    key={b}
                                    onClick={() => setSelectedBuilding(b)}
                                    className={`w-full text-left px-3 py-2.5 rounded-xl text-sm mb-1 transition-all flex justify-between items-center ${selectedBuilding === b ? 'bg-indigo-600 text-white font-bold' : 'hover:bg-slate-800'}`}
                                >
                                    <span className="flex items-center gap-2">
                                        <Icon name="building-2" size={16} /> {b}
                                    </span>
                                    {selectedBuilding === b && <Icon name="check" size={14} />}
                                </button>
                            ))}
                        </div>

                        <div className="p-4 border-t border-slate-800">
                            <button 
                                onClick={() => setActiveView(activeView === 'checklist' ? 'settings' : 'checklist')}
                                className="w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm hover:bg-slate-800"
                            >
                                <Icon name="settings" size={16} /> 
                                {activeView === 'checklist' ? 'Manage Buildings' : 'Back to Tasks'}
                            </button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto">
                        <header className="bg-white border-b p-6 sticky top-0 z-10 flex justify-between items-center">
                            <div>
                                <h2 className="text-xl font-black text-slate-800">{selectedBuilding}</h2>
                                <p className="text-xs text-slate-400 font-bold uppercase tracking-wider">Compliance Dashboard</p>
                            </div>
                            <div className="relative">
                                <input 
                                    type="text" 
                                    placeholder="Search requirements..." 
                                    className="pl-10 pr-4 py-2 bg-slate-100 rounded-xl text-sm outline-none w-64 focus:ring-2 focus:ring-indigo-500 transition-all"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                                <Icon name="search" size={16} className="absolute left-3 top-2.5 text-slate-400" />
                            </div>
                        </header>

                        <div className="p-8 max-w-5xl mx-auto">
                            {notification && (
                                <div className="mb-6 p-4 bg-indigo-600 text-white rounded-xl text-sm font-bold shadow-lg animate-in flex items-center gap-2">
                                    <Icon name="info" size={18} /> {notification}
                                </div>
                            )}

                            {activeView === 'checklist' ? (
                                Object.entries(groupedTasks).map(([category, items]) => (
                                    <div key={category} className="mb-10">
                                        <div className="flex items-center gap-4 mb-4">
                                            <h3 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em]">{category}</h3>
                                            <div className="h-px flex-1 bg-slate-200"></div>
                                        </div>
                                        
                                        <div className="space-y-3">
                                            {items.map(task => {
                                                const isExpanded = expandedTaskId === task.id;
                                                return (
                                                    <div key={task.id} className={`bg-white border rounded-2xl overflow-hidden shadow-sm transition-all ${task.completed ? 'border-green-100 bg-green-50/10' : 'hover:border-indigo-200'}`}>
                                                        <div 
                                                            className="p-4 flex items-center gap-4 cursor-pointer" 
                                                            onClick={() => setExpandedTaskId(isExpanded ? null : task.id)}
                                                        >
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); toggleTask(task.id); }}
                                                                className={`w-8 h-8 rounded-xl border-2 flex items-center justify-center transition-all ${task.completed ? 'bg-green-500 border-green-500 text-white' : 'border-slate-200 bg-white'}`}
                                                            >
                                                                {task.completed && <Icon name="check" size={18} />}
                                                            </button>
                                                            <div className="flex-1">
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-[9px] font-black bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded uppercase tracking-tighter">{task.subcategory}</span>
                                                                    <p className={`font-bold ${task.completed ? 'text-slate-400 line-through' : 'text-slate-800'}`}>{task.name}</p>
                                                                </div>
                                                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-tight">
                                                                    {task.frequency} • {task.citation} • {task.authority}
                                                                </p>
                                                            </div>
                                                            <div className="flex items-center gap-3">
                                                                {task.attachments.length > 0 && <span className="bg-indigo-50 text-indigo-600 text-[10px] px-2 py-1 rounded-lg font-black flex items-center gap-1"><Icon name="file" size={10} /> {task.attachments.length}</span>}
                                                                <Icon name={isExpanded ? "chevron-up" : "chevron-down"} size={18} className="text-slate-300" />
                                                            </div>
                                                        </div>
                                                        
                                                        {isExpanded && (
                                                            <div className="px-16 pb-6 pt-2 animate-in">
                                                                <div className="bg-slate-50 p-5 rounded-2xl border border-slate-100 grid grid-cols-2 gap-6">
                                                                    <div>
                                                                        <label className="text-[10px] font-black text-slate-400 uppercase block mb-1">Action Required</label>
                                                                        <p className="text-sm text-slate-700 font-medium">{task.action} by {task.performedBy}</p>
                                                                        
                                                                        <div className="mt-4">
                                                                            <label className="text-[10px] font-black text-slate-400 uppercase block mb-2">Evidence / Logs</label>
                                                                            <div className="flex flex-wrap gap-2 mb-3">
                                                                                {task.attachments.map((f, i) => (
                                                                                    <div key={i} className="bg-white border text-[10px] px-2 py-1 rounded-md flex items-center gap-1 font-bold text-slate-600">
                                                                                        <Icon name="file-text" size={10} /> {f.name}
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                            <button 
                                                                                onClick={() => handleFileUpload(task.id)}
                                                                                className="text-xs font-black text-indigo-600 flex items-center gap-1 hover:underline"
                                                                            >
                                                                                <Icon name="upload" size={12} /> Upload New Document
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <div className="flex flex-col justify-between items-end">
                                                                        <textarea 
                                                                            placeholder="Add internal notes..."
                                                                            className="w-full text-xs p-3 rounded-xl border border-slate-200 h-24 outline-none focus:ring-2 focus:ring-indigo-500"
                                                                        />
                                                                        <button 
                                                                            onClick={() => toggleApplicable(task.id)}
                                                                            className="mt-4 text-[10px] font-black text-slate-400 hover:text-red-500 uppercase flex items-center gap-1"
                                                                        >
                                                                            <Icon name="alert-triangle" size={12} /> Hide (Does not apply to this site)
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="bg-white p-10 rounded-3xl border border-slate-200 shadow-sm animate-in">
                                    <h3 className="text-xl font-black text-slate-800 mb-6 flex items-center gap-3">
                                        <Icon name="settings" className="text-indigo-600" /> Building Registry
                                    </h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        {buildings.map(b => (
                                            <div key={b} className="p-4 rounded-2xl border bg-slate-50 flex items-center justify-between group">
                                                <span className="font-bold text-slate-700">{b}</span>
                                                <button 
                                                    onClick={() => {
                                                        const newTasks = tasks.filter(t => t.building !== b);
                                                        setTasks(newTasks);
                                                        const newBuildings = buildings.filter(x => x !== b);
                                                        setBuildings(newBuildings);
                                                        if(selectedBuilding === b) setSelectedBuilding(newBuildings[0] || '');
                                                    }}
                                                    className="text-slate-300 hover:text-red-500 transition-all"
                                                >
                                                    <Icon name="trash-2" size={16} />
                                                </button>
                                            </div>
                                        ))}
                                        <button 
                                            onClick={() => {
                                                const n = prompt("New Building Name:");
                                                if(n) {
                                                    setBuildings([...buildings, n]);
                                                    // Inherit existing tasks
                                                    const newBuildingTasks = masterList.map((m, idx) => ({
                                                        ...m,
                                                        id: `${n}-${idx}-${Date.now()}`,
                                                        building: n,
                                                        attachments: [],
                                                        completed: false,
                                                        applicable: true,
                                                        notes: ""
                                                    }));
                                                    setTasks([...tasks, ...newBuildingTasks]);
                                                    showNotification(`${n} added to registry`);
                                                }
                                            }}
                                            className="p-4 rounded-2xl border-2 border-dashed border-slate-200 flex items-center justify-center gap-2 text-slate-400 hover:border-indigo-400 hover:text-indigo-600 transition-all font-bold text-sm"
                                        >
                                            <Icon name="plus-circle" size={18} /> Register New Facility
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
